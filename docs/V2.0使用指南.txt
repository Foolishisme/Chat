=================================================================
RAG对话系统 V2.0 使用指南
=================================================================

📅 发布日期: 2025-11-14
📌 版本: V2.0
🚀 状态: 生产就绪

=================================================================
🎉 V2.0 新功能概览
=================================================================

本次更新带来三大核心功能，将RAG系统从"单次问答"升级到"连续对话"：

1. 🧠 对话记忆功能
   - 支持最多10轮对话历史（20条消息）
   - 自动理解上下文引用（"你刚才说的"、"继续"等）
   - 多用户会话隔离

2. 🆕 新建对话功能
   - 一键清空历史，开始新话题
   - 避免旧对话干扰新主题

3. 📄 文件上传功能
   - 无需重启服务即可更换文档
   - 自动重建向量索引
   - 实时进度反馈

=================================================================
🖥️ 使用方法
=================================================================

方法一：Web界面（推荐）
-----------------------------------------------------------------

1. 启动服务
   ```
   python main.py
   ```

2. 打开浏览器
   ```
   http://localhost:8000
   ```

3. 对话记忆使用
   - 💬 直接提问，系统会自动记住对话历史
   - 🔄 可以引用前面的内容："你刚才提到的观点是什么？"
   - ✅ 系统会在前10轮对话中保持上下文

4. 新建对话
   - 🆕 点击顶部"新对话"按钮
   - ✅ 历史记录清空，开始全新话题

5. 上传新文档
   - 📄 点击顶部"上传文档"按钮
   - 📁 选择PDF文件
   - ⏳ 等待上传和索引完成
   - ✅ 可以对新文档提问了

方法二：API调用
-----------------------------------------------------------------

### 1. 创建新会话

```bash
curl -X POST "http://localhost:8000/session/new"
```

响应：
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "success"
}
```

### 2. 发送对话（带历史）

```bash
curl -X POST "http://localhost:8000/chat/stream" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "文档的核心观点是什么？",
    "session_id": "550e8400-e29b-41d4-a716-446655440000"
  }'
```

### 3. 查看会话历史

```bash
curl "http://localhost:8000/session/{session_id}/history"
```

### 4. 上传新文档

```bash
curl -X POST "http://localhost:8000/upload" \
  -F "file=@新文档.pdf"
```

=================================================================
💡 使用技巧
=================================================================

1. 对话记忆最佳实践
   ✅ 使用自然语言引用：
      - "你刚才说的..."
      - "继续上面的话题"
      - "详细解释一下"
   ❌ 避免：
      - 超过10轮后的历史引用
      - 混合多个文档的讨论（使用新对话隔离）

2. 何时新建对话
   ✅ 推荐场景：
      - 切换到完全不同的主题
      - 对话历史过长（超过8-10轮）
      - 上传新文档后
   💡 提示：旧对话历史不会被删除（服务器内存中保留）

3. 文档上传注意事项
   ✅ 支持：PDF格式
   ❌ 不支持：Word、TXT、图片等
   ⚠️ 限制：文件大小建议 < 50MB
   💡 提示：上传新文档会替换旧文档，但不会删除旧文档文件

=================================================================
🔧 技术细节
=================================================================

对话记忆实现
-----------------------------------------------------------------
- 存储方式：内存（sessions字典）
- 存储内容：
  * role: "user" 或 "assistant"
  * content: 消息内容
  * timestamp: 时间戳
- 清理策略：自动保留最近20条消息（10轮对话）
- 并发支持：多用户通过session_id隔离

会话管理
-----------------------------------------------------------------
- Session ID: UUID v4格式
- 生命周期：
  * 创建：调用 /session/new 或首次对话
  * 使用：每次对话传递 session_id
  * 删除：调用 DELETE /session/{id} 或服务重启
- 持久化：否（内存存储，重启后丢失）

文件上传流程
-----------------------------------------------------------------
1. 前端：选择PDF文件
2. 后端：验证文件格式（.pdf）
3. 保存：写入文件到指定目录
4. 加载：PyPDFLoader读取文档
5. 分割：RecursiveCharacterTextSplitter (600/100)
6. 向量化：HuggingFace Embeddings
7. 索引：FAISS向量数据库
8. 完成：返回成功响应

=================================================================
⚠️ 注意事项与限制
=================================================================

1. 会话持久化
   ❌ 当前版本使用内存存储
   ⚠️ 服务重启后所有会话历史丢失
   💡 未来版本：计划使用Redis或数据库持久化

2. 文件上传安全
   ⚠️ 当前版本仅验证文件扩展名
   💡 生产环境：需要添加文件内容验证、病毒扫描等

3. 并发限制
   ⚠️ 文件上传时会重建向量索引
   ⚠️ 此时其他用户的查询可能受影响
   💡 生产环境：建议添加任务队列和锁机制

4. 内存使用
   ⚠️ 每个会话的历史记录占用内存
   ⚠️ 长期运行可能累积大量会话
   💡 建议：定期清理过期会话（未来版本）

=================================================================
🐛 常见问题
=================================================================

Q1: 为什么我的对话历史没有保存？
A: 请确保：
   1. 每次请求都传递相同的 session_id
   2. 服务没有重启（会话存储在内存中）
   3. 历史记录在最近10轮内

Q2: 上传文档后为什么之前的对话还在？
A: 上传文档不会清空会话历史。如需重新开始，请点击"新对话"。

Q3: 可以同时上传多个文档吗？
A: 当前版本只支持单文档模式。每次上传新文档会替换旧文档的向量索引。

Q4: 对话记忆会影响性能吗？
A: 影响很小。历史记录会附加到Prompt中，略微增加Token消耗，
   但通过最多10轮的限制，保持在合理范围内。

Q5: 如何清空所有会话历史？
A: 重启服务即可（所有会话存储在内存中）。

=================================================================
🚀 未来规划（V3.0+）
=================================================================

根据当前RAG系统的基础，后续版本可能包括：

V3.0 候选功能：
1. 🔥 混合检索 + 重排序
   - BM25关键词检索 + 向量检索融合
   - Cross-Encoder重排序
   - 预期：召回率提升20-30%

2. 🤖 工具调用（Function Calling）
   - 网络搜索工具（实时信息）
   - 计算器工具
   - 数据库查询工具
   - 迈向Agent的关键一步

3. 📚 多文档管理
   - 支持多个PDF文档同时索引
   - Metadata过滤检索
   - 文档版本控制

4. 🗄️ 会话持久化
   - Redis或数据库存储
   - 跨服务重启保持历史
   - 会话导出/导入

5. 🖼️ 多模态支持
   - 提取PDF中的图片和表格
   - 图片描述生成（Vision API）
   - 表格结构化识别

=================================================================
📞 技术支持
=================================================================

文档位置：
- 项目README: README.md
- API文档: http://localhost:8000/docs
- 时延分析: docs/时延分析报告.txt
- 切片评估: docs/切片策略评估报告.txt

问题反馈：
请查看开发日志（README.md）了解最新更新和已知问题。

=================================================================
🎓 学习资源
=================================================================

本项目涉及的核心技术：
1. RAG（检索增强生成）架构
2. 向量数据库（FAISS）
3. Embedding技术（HuggingFace）
4. LLM API调用（Google Gemini）
5. 流式输出（Server-Sent Events）
6. 会话管理（Session Management）
7. 文件上传（Multipart Form Data）

推荐学习路径：
1. 理解RAG基础原理
2. 掌握向量检索技术
3. 学习Prompt工程
4. 探索混合检索方法
5. 研究Agent系统设计

=================================================================

